name: Trigger Deploy Scripts Only for Changed Services

on:
  push:
    paths:
      - 'docker/**'
  pull_request:
    paths:
      - 'docker/**'

jobs:
  filter:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.filter.outputs.changed }}
      matrix: ${{ steps.filter.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            alertmanager: 'docker/alertmanager/**'
            authentik: 'docker/authentik/**'
            authentik-proxy-outpost: 'docker/authentik-proxy-outpost/**'
            bastion-hosts: 'docker/bastion-hosts/**'
            code-server: 'docker/code-server/**'
            db-management-tools: 'docker/db-management-tools/**'
            dokploy: 'docker/dokploy/**'
            gitlab: 'docker/gitlab/**'
            hashicorp-vault: 'docker/hashicorp-vault/**'
            influxdb2: 'docker/influxdb2/**'
            kasm-worksppace: 'docker/kasm-worksppace/**'
            logging-agents: 'docker/logging-agents/**'
            logging-agents-v2: 'docker/logging-agents-v2/**'
            mariadb: 'docker/mariadb/**'
            monitoring-agents: 'docker/monitoring-agents/**'
            netmaker: 'docker/netmaker/**'
            nextcloud-full: 'docker/nextcloud-full/**'
            notifications: 'docker/notifications/**'
            onlyoffice: 'docker/onlyoffice/**'
            portainer: 'docker/portainer/**'
            postgres-swarm: 'docker/postgres-swarm/**'
            proxy: 'docker/proxy/**'
            redis-prd: 'docker/redis-prd/**'
            shepherd-containrrrr: 'docker/shepherd-containrrrr/**'
            teleport: 'docker/teleport/**'
            test-gitlab-cicd: 'docker/test-gitlab-cicd/**'
            traefik: 'docker/traefik/**'
            valkey: 'docker/valkey/**'
            wireguard: 'docker/wireguard/**'
            
  deploy:
    needs: filter
    if: needs.filter.outputs.changed == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.filter.outputs.matrix) }}
    steps:
      - name: Run deploy script on Swarm manager
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SWARM_HOST }}
          username: ${{ secrets.SWARM_USER }}
          key: ${{ secrets.SWARM_SSH_KEY }}
          script: |
            cd /mnt/git/My-DevOps
            git pull origin ${{ github.ref_name }}
            cd docker/${{ matrix.service }}
            script="deploy_${{ matrix.service }}.sh"
            if [ -f "$script" ]; then
              bash "$script"
            else
              echo "No deploy script found for ${{ matrix.service }}"
              echo "Using default deploy script."
              docker stack deploy -c docker-compose.yml ${{ matrix.service }}
            fi
