services:
  postgres-primary:
    image: postgres:${IMAGE_TAG:-17}
    secrets:
      - postgres-root-password
    volumes:
      - ${PRIMARY_DATA_FOLDER}/postgres-primary:/var/lib/postgresql/data
      - ${PRIMARY_DATA_FOLDER}/postgres-primary-archive:/var/lib/postgresql/archive
    configs:
      - source: postgres-ha-primary-conf
        target: /etc/postgresql/conf.d/extended.conf
      - source: pg-hba-ha-primary-conf
        target: /etc/postgresql/pg_hba.conf
      - source: postgres-ha-init-replicator
        target: /docker-entrypoint-initdb.d/init-replicator.sh
        mode: 0755
    networks:
      db-internetwork:
        aliases:
          - postgres-primary
    deploy:
      update_config:
        parallelism: 1
        delay: 5s
        failure_action: rollback
      restart_policy:
        condition: any
      resources:
        limits:
          cpus: "2"
          memory: "8G"
        reservations:
          cpus: "0.5"
          memory: "4G"
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.database == master
    environment:
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres-root-password
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
      - POSTGRES_HOST_AUTH_METHOD=md5
      - POSTGRES_INITDB_ARGS=--auth-host=md5 --auth-local=md5
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/conf.d/extended.conf
      - -c
      - hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  postgres-standby:
    image: postgres:${IMAGE_TAG:-17}
    secrets:
      - postgres-root-password
    volumes:
      - ${STANDBY_DATA_FOLDER}/postgres-standby:/var/lib/postgresql/data
    configs:
      - source: postgres-ha-standby-conf
        target: /etc/postgresql/conf.d/extended.conf
      - source: pg-hba-ha-standby-conf
        target: /etc/postgresql/pg_hba.conf
    networks:
      db-internetwork:
        aliases:
          - postgres-standby
          - postgres-replica
    deploy:
      update_config:
        parallelism: 1
        delay: 5s
        failure_action: rollback
      restart_policy:
        condition: any
      resources:
        limits:
          cpus: "1"
          memory: "2G"
        reservations:
          cpus: "0.25"
          memory: "1G"
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.database == slave
    environment:
      - PGDATA=/var/lib/postgresql/data
    command:
      - bash
      - -c
      - |
        set -e
        chown -R postgres:postgres $$PGDATA
        chmod 700 $$PGDATA
        if [ ! -s "$$PGDATA/PG_VERSION" ]; then
          until pg_isready -h postgres-primary -p 5432 -U postgres; do
            sleep 5
          done
          export PGPASSWORD=$$(cat /run/secrets/postgres-root-password)
          /usr/local/bin/gosu postgres pg_basebackup -h postgres-primary -D $$PGDATA -U replicator -v -P -R -X stream -S standby_slot || \
            /usr/local/bin/gosu postgres pg_basebackup -h postgres-primary -D $$PGDATA -U replicator -v -P -R -X stream -C -S standby_slot
        fi
        exec /usr/local/bin/gosu postgres postgres -c config_file=/etc/postgresql/conf.d/extended.conf -c hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s

  # PgCat: Next-gen PostgreSQL Pooler - THE SINGLE ENTRY POINT
  # Combines connection pooling + read/write splitting + load balancing + failover
  # Applications connect here → PgCat → DB nodes (primary/standby)
  pgcat-transaction:
    image: ghcr.io/postgresml/pgcat:${PGCAT_TAG:-latest}
    configs:
      - source: pgcat-transaction-ha-config
        target: /etc/pgcat/pgcat.toml
    networks:
      db-internetwork:
        aliases:
          - pooler-transaction
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      resources:
        limits:
          cpus: "0.5"
          memory: "256M"
        reservations:
          cpus: "0.1"
          memory: "64M"
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 6432 -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  pgcat-session:
    image: ghcr.io/postgresml/pgcat:${PGCAT_TAG:-latest}
    configs:
      - source: pgcat-session-ha-config
        target: /etc/pgcat/pgcat.toml
    networks:
      db-internetwork:
        aliases:
          - pooler-session
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      resources:
        limits:
          cpus: "0.5"
          memory: "256M"
        reservations:
          cpus: "0.1"
          memory: "64M"
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 6432 -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

networks:
  db-internetwork:
    external: true

secrets:
  postgres-root-password:
    external: true

configs:
  postgres-ha-primary-conf:
    external: true
  pg-hba-ha-primary-conf:
    external: true
  postgres-ha-init-replicator:
    external: true
  postgres-ha-standby-conf:
    external: true
  pg-hba-ha-standby-conf:
    external: true
  pgcat-transaction-ha-config:
    external: true
  pgcat-session-ha-config:
    external: true
