services:
  postgres-primary:
    image: postgres:${IMAGE_TAG:-17}
    secrets:
      - postgres-root-password
    volumes:
      - ${PRIMARY_DATA_FOLDER}/postgres-primary:/var/lib/postgresql/data
      - ${PRIMARY_DATA_FOLDER}/postgres-primary-archive:/var/lib/postgresql/archive
    configs:
      - source: postgres-primary-conf
        target: /etc/postgresql/conf.d/extended.conf
      - source: pg-hba-primary-conf
        target: /etc/postgresql/pg_hba.conf
      - source: postgres-init-replicator
        target: /docker-entrypoint-initdb.d/init-replicator.sh
        mode: 0755
    networks:
      db-internetwork:
        aliases:
          - postgres-primary
    deploy:
      update_config:
        parallelism: 1
        delay: 5s
        failure_action: rollback
      restart_policy:
        condition: any
      resources:
        limits:
          cpus: "2"
          memory: "8G"
        reservations:
          cpus: "0.5"
          memory: "4G"
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.database == master
    environment:
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres-root-password
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
      - POSTGRES_HOST_AUTH_METHOD=md5
      - POSTGRES_INITDB_ARGS=--auth-host=md5 --auth-local=md5
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/conf.d/extended.conf
      - -c
      - hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  postgres-standby:
    image: postgres:${IMAGE_TAG:-17}
    secrets:
      - postgres-root-password
    volumes:
      - ${STANDBY_DATA_FOLDER}/postgres-standby:/var/lib/postgresql/data
    configs:
      - source: postgres-standby-conf
        target: /etc/postgresql/conf.d/extended.conf
      - source: pg-hba-standby-conf
        target: /etc/postgresql/pg_hba.conf
    networks:
      db-internetwork:
        aliases:
          - postgres-standby
          - postgres-replica
    deploy:
      update_config:
        parallelism: 1
        delay: 5s
        failure_action: rollback
      restart_policy:
        condition: any
      resources:
        limits:
          cpus: "1"
          memory: "2G"
        reservations:
          cpus: "0.25"
          memory: "1G"
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.database == slave
    environment:
      - PGDATA=/var/lib/postgresql/data
    command:
      - bash
      - -c
      - |
        set -e
        chown -R postgres:postgres $$PGDATA
        chmod 700 $$PGDATA
        if [ ! -s "$$PGDATA/PG_VERSION" ]; then
          until pg_isready -h postgres-primary -p 5432 -U postgres; do
            sleep 5
          done
          export PGPASSWORD=$$(cat /run/secrets/postgres-root-password)
          /usr/local/bin/gosu postgres pg_basebackup -h postgres-primary -D $$PGDATA -U replicator -v -P -R -X stream -S standby_slot || \
            /usr/local/bin/gosu postgres pg_basebackup -h postgres-primary -D $$PGDATA -U replicator -v -P -R -X stream -C -S standby_slot
        fi
        exec /usr/local/bin/gosu postgres postgres -c config_file=/etc/postgresql/conf.d/extended.conf -c hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s

  pgbouncer-session:
    image: edoburu/pgbouncer:${PGBOUNCER_TAG:-latest}
    configs:
      - source: pgbouncer-session-ini
        target: /etc/pgbouncer/pgbouncer.ini
      - source: pgbouncer-userlist
        target: /etc/pgbouncer/userlist.txt
    networks:
      db-internetwork:
        aliases:
          - pgbouncer-session-ha
          - pgbouncer-write
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432 -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  pgbouncer-transaction:
    image: edoburu/pgbouncer:${PGBOUNCER_TAG:-latest}
    configs:
      - source: pgbouncer-transaction-ini
        target: /etc/pgbouncer/pgbouncer.ini
      - source: pgbouncer-userlist
        target: /etc/pgbouncer/userlist.txt
    networks:
      db-internetwork:
        aliases:
          - pgbouncer-transaction-ha
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432 -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  pgbouncer-read:
    image: edoburu/pgbouncer:${PGBOUNCER_TAG:-latest}
    configs:
      - source: pgbouncer-read-ini
        target: /etc/pgbouncer/pgbouncer.ini
      - source: pgbouncer-userlist
        target: /etc/pgbouncer/userlist.txt
    networks:
      db-internetwork:
        aliases:
          - pgbouncer-read-ha
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432 -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  db-internetwork:
    external: true

secrets:
  postgres-root-password:
    external: true

configs:
  postgres-primary-conf:
    external: true
  pg-hba-primary-conf:
    external: true
  postgres-init-replicator:
    external: true
  postgres-standby-conf:
    external: true
  pg-hba-standby-conf:
    external: true
  pgbouncer-session-ini:
    external: true
  pgbouncer-transaction-ini:
    external: true
  pgbouncer-read-ini:
    external: true
  pgbouncer-userlist:
    external: true
